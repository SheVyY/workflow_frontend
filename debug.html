<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Debug</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            line-height: 1.5;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow: auto;
            white-space: pre-wrap;
        }
        button {
            padding: 8px 16px;
            margin-right: 8px;
            margin-bottom: 10px;
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #3182ce;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
    </style>
</head>
<body>
    <h1>Supabase Connectivity Debug</h1>
    
    <div>
        <button id="test-connection">Test Connection</button>
        <button id="fetch-dev-feeds">Fetch Dev Feeds</button>
        <button id="test-realtime">Test Realtime</button>
    </div>
    
    <h2>Results:</h2>
    <pre id="results">Click a button to run tests...</pre>
    
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        
        // Get Supabase credentials from .env.local (in actual code, these would be injected by Vite)
        const supabaseUrl = 'https://hgewkffoornpfblqrcyn.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnZXdrZmZvb3JucGZibHFyY3luIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQzODEwOTcsImV4cCI6MjA1OTk1NzA5N30.9H4Pk3y08qpwNayKZ55LQMD-qh9owCAF6rvlEJPVdKY';
        
        // Create Supabase client
        const supabase = createClient(supabaseUrl, supabaseKey);
        
        // DOM elements
        const resultsEl = document.getElementById('results');
        const testConnectionBtn = document.getElementById('test-connection');
        const fetchDevFeedsBtn = document.getElementById('fetch-dev-feeds');
        const testRealtimeBtn = document.getElementById('test-realtime');
        
        // Helper function to log results
        function log(message, type = 'info') {
            const now = new Date().toLocaleTimeString();
            const line = `[${now}] ${message}`;
            
            if (type === 'error') {
                console.error(message);
                resultsEl.innerHTML += `<div class="error">${line}</div>`;
            } else if (type === 'success') {
                console.log(message);
                resultsEl.innerHTML += `<div class="success">${line}</div>`;
            } else {
                console.log(message);
                resultsEl.innerHTML += `<div>${line}</div>`;
            }
            
            // Scroll to bottom
            resultsEl.scrollTop = resultsEl.scrollHeight;
        }
        
        // Test basic connection
        async function testConnection() {
            resultsEl.innerHTML = ''; // Clear previous results
            log('Testing connection to Supabase...');
            
            try {
                const { data, error } = await supabase
                    .from('dev_news_feeds')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    log(`Connection error: ${error.message}`, 'error');
                    return;
                }
                
                log('Successfully connected to Supabase!', 'success');
                log(`Database returned ${data.length} rows`);
                log(`First row: ${JSON.stringify(data[0], null, 2)}`);
                
                // Check if tables exist
                const tables = ['dev_news_feeds', 'dev_news_items'];
                for (const table of tables) {
                    log(`Checking table: ${table}`);
                    const { data: tableData, error: tableError } = await supabase
                        .from(table)
                        .select('id')
                        .limit(1);
                    
                    if (tableError) {
                        log(`Table ${table} error: ${tableError.message}`, 'error');
                    } else {
                        log(`Table ${table} exists and is accessible`, 'success');
                    }
                }
                
            } catch (error) {
                log(`Unexpected error: ${error.message}`, 'error');
            }
        }
        
        // Fetch dev feeds
        async function fetchDevFeeds() {
            resultsEl.innerHTML = ''; // Clear previous results
            log('Fetching all development feeds...');
            
            try {
                const { data, error } = await supabase
                    .from('dev_news_feeds')
                    .select(`
                        id,
                        submission_id,
                        title,
                        date,
                        dev_news_items (
                            id,
                            title,
                            content,
                            source,
                            source_url,
                            category
                        )
                    `)
                    .order('date', { ascending: false });
                
                if (error) {
                    log(`Error fetching feeds: ${error.message}`, 'error');
                    return;
                }
                
                if (!data || data.length === 0) {
                    log('No development feeds found in the database', 'error');
                    return;
                }
                
                log(`Successfully fetched ${data.length} development feeds`, 'success');
                
                // Log basic info about each feed
                data.forEach((feed, index) => {
                    const items = feed.dev_news_items || [];
                    log(`Feed ${index + 1}: ID=${feed.id}, Submission=${feed.submission_id}, Items=${items.length}`);
                });
                
                // Format the data (similar to your application code)
                const formattedData = data.map(feed => {
                    return {
                        ...feed,
                        news_items: feed.dev_news_items || []
                    };
                });
                
                log('First formatted feed:');
                log(JSON.stringify(formattedData[0], null, 2));
                
            } catch (error) {
                log(`Unexpected error: ${error.message}`, 'error');
            }
        }
        
        // Test Realtime
        function testRealtime() {
            resultsEl.innerHTML = ''; // Clear previous results
            log('Setting up Realtime subscription...');
            
            try {
                const subscription = supabase
                    .channel('public:dev_news_feeds')
                    .on('postgres_changes', { 
                        event: '*', 
                        schema: 'public', 
                        table: 'dev_news_feeds' 
                    }, (payload) => {
                        log(`Realtime event received: ${payload.eventType}`, 'success');
                        log(`Payload: ${JSON.stringify(payload, null, 2)}`);
                    })
                    .subscribe((status) => {
                        log(`Subscription status: ${status}`);
                        
                        if (status === 'SUBSCRIBED') {
                            log('Successfully subscribed to Realtime!', 'success');
                            log('Waiting for database changes...');
                            log('(You can run node scripts/generate-dev-data.js in another terminal to trigger events)');
                        }
                    });
                
                // Add unsubscribe functionality
                const unsubscribeBtn = document.createElement('button');
                unsubscribeBtn.textContent = 'Unsubscribe';
                unsubscribeBtn.onclick = () => {
                    subscription.unsubscribe();
                    log('Unsubscribed from Realtime');
                    unsubscribeBtn.disabled = true;
                };
                
                document.querySelector('div').appendChild(unsubscribeBtn);
                
            } catch (error) {
                log(`Unexpected error: ${error.message}`, 'error');
            }
        }
        
        // Event listeners
        testConnectionBtn.addEventListener('click', testConnection);
        fetchDevFeedsBtn.addEventListener('click', fetchDevFeeds);
        testRealtimeBtn.addEventListener('click', testRealtime);
        
        // Initial test
        log('Debug page loaded. Click a button to run tests.');
    </script>
</body>
</html> 